<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± P2P –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä - –ì—Ä—É–ø–ø—ã –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #0f172a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≥—Ä—É–ø–ø—ã */
        .sidebar {
            width: 300px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
        }
        
        .user-panel {
            padding: 20px;
            border-bottom: 1px solid #334155;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
        }
        
        .user-avatar:hover {
            opacity: 0.9;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
        }
        
        .user-id {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 3px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #334155;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #1e293b;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .contacts-list, .groups-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .contact-item, .group-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
        }
        
        .contact-item:hover, .group-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .contact-item.active, .group-item.active {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
        }
        
        .contact-avatar, .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .contact-avatar {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .group-avatar {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .contact-info, .group-info {
            flex: 1;
        }
        
        .contact-name, .group-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .contact-status, .group-members {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .contact-status.online {
            color: #10b981;
        }
        
        .add-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .add-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        
        /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - —á–∞—Ç */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f172a;
        }
        
        .chat-header {
            padding: 20px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .chat-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #475569;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-btn:hover {
            background: #64748b;
        }
        
        .chat-btn.primary {
            background: #3b82f6;
        }
        
        .chat-btn.primary:hover {
            background: #2563eb;
        }
        
        .chat-btn.success {
            background: #10b981;
        }
        
        .chat-btn.success:hover {
            background: #059669;
        }
        
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.received {
            background: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .message.sent {
            background: #1e40af;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .message-sender {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
            text-align: right;
        }
        
        .message-input-area {
            padding: 20px;
            background: #1e293b;
            border-top: 1px solid #334155;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 15px 20px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .message-input:focus {
            border-color: #3b82f6;
        }
        
        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .send-btn:hover {
            background: #2563eb;
        }
        
        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏/—É—á–∞—Å—Ç–Ω–∏–∫–∏ */
        .side-panel {
            width: 300px;
            background: #1e293b;
            border-left: 1px solid #334155;
            display: none;
            flex-direction: column;
        }
        
        .side-panel.active {
            display: flex;
        }
        
        .side-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .side-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 30px;
        }
        
        .settings-section h4 {
            color: #3b82f6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #10b981;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .members-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #3b82f6;
        }
        
        .modal-content h3 {
            color: #3b82f6;
            margin-bottom: 20px;
        }
        
        .modal-input {
            width: 100%;
            padding: 15px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .modal-btn.primary {
            background: #3b82f6;
            color: white;
        }
        
        .modal-btn.secondary {
            background: #475569;
            color: white;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
        }
        
        .notification.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1200px) {
            .side-panel {
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh;
                z-index: 100;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 100;
                display: none;
            }
            
            .sidebar.active {
                display: flex;
            }
            
            .side-panel {
                width: 100%;
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh;
                z-index: 100;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –≥—Ä—É–ø–ø—ã -->
        <div class="sidebar" id="sidebar">
            <div class="user-panel">
                <div class="user-info">
                    <div class="user-avatar" onclick="showSettings()">–Ø</div>
                    <div class="user-details" onclick="showSettings()">
                        <div class="user-name" id="userName">–í—ã</div>
                        <div class="user-id" id="userId">ID: –∑–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('contacts')">üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
                <button class="tab" onclick="switchTab('groups')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ì—Ä—É–ø–ø—ã</button>
            </div>
            
            <div class="contacts-list" id="contactsList">
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="groups-list" id="groupsList" style="display: none;">
                <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <button class="add-btn" onclick="showAddModal()">+</button>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å - —á–∞—Ç -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="contact-avatar" id="chatAvatar">–ß</div>
                    <div>
                        <h3 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <div id="chatStatus" style="font-size: 14px; color: #94a3b8;">
                            –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ
                        </div>
                    </div>
                </div>
                
                <div class="chat-actions">
                    <button class="chat-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <button class="chat-btn primary" onclick="startCall()" id="callBtn">
                        üìû
                    </button>
                    <button class="chat-btn success" onclick="toggleSidePanel('members')" id="membersBtn">
                        üë•
                    </button>
                    <button class="chat-btn" onclick="toggleSidePanel('settings')" id="settingsBtn">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div style="text-align: center; color: #94a3b8; padding: 40px;">
                    <h3>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
                </div>
            </div>
            
            <div class="message-input-area">
                <div class="input-container">
                    <input type="text" class="message-input" id="messageInput" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           onkeypress="if(event.key === 'Enter') sendMessage()"
                           disabled>
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>
                        ‚û§
                    </button>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏/—É—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="side-panel" id="sidePanel">
            <div class="side-header">
                <h3 id="sidePanelTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button class="chat-btn" onclick="toggleSidePanel()">‚úï</button>
            </div>
            
            <div class="side-content" id="sidePanelContent">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å</h3>
            <button class="modal-btn primary" onclick="showAddContactModal()" style="margin-bottom: 10px;">
                üë§ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
            </button>
            <button class="modal-btn primary" onclick="showCreateGroupModal()">
                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
            </button>
            <button class="modal-btn secondary" onclick="hideModal()" style="margin-top: 10px;">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
    
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <h3>üë§ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
            <input type="text" class="modal-input" id="contactIdInput" placeholder="ID –¥—Ä—É–≥–∞...">
            <input type="text" class="modal-input" id="contactNameInput" placeholder="–ò–º—è –¥—Ä—É–≥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="hideModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="addContact()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
            <input type="text" class="modal-input" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <input type="text" class="modal-input" id="groupIdsInput" placeholder="ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="hideModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <input type="text" class="modal-input" id="nameInput" placeholder="–í–∞—à–µ –∏–º—è" value="–í—ã">
            <div style="margin-bottom: 20px;">
                <div style="font-weight: 600; margin-bottom: 10px;">–í–∞—à ID:</div>
                <div style="background: #334155; padding: 15px; border-radius: 8px; font-family: monospace; word-break: break-all;" id="settingsUserId">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
                <button onclick="copyMyId()" style="margin-top: 10px; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; width: 100%; cursor: pointer;">
                    üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–π ID
                </button>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="hideModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-btn primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div class="notification" id="notification">
        <span id="notificationText">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</span>
    </div>

    <script>
        // ========== –î–ê–ù–ù–´–ï ==========
        let peer = null;
        let myId = null;
        let myName = "–í—ã";
        let connections = {}; // –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        
        let contacts = [];
        let groups = [];
        let currentChat = null; // {type: 'contact'/'group', id: '...'}
        let messages = {}; // –•—Ä–∞–Ω–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ chatId
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Peer
            peer = new Peer({
                config: {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                myId = id;
                updateUI();
                showNotification('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –í–∞—à ID: ' + id);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                addTestData();
            });
            
            peer.on('connection', (conn) => {
                // –ö—Ç–æ-—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–∞–º
                handleIncomingConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error('PeerJS –æ—à–∏–±–∫–∞:', err);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }
        
        function addTestData() {
            // –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
            contacts.push({
                id: 'TEST-CONTACT',
                name: '–î—Ä—É–≥ 1',
                avatar: '–î',
                online: true,
                type: 'contact'
            });
            
            // –¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
            groups.push({
                id: 'TEST-GROUP',
                name: '–ì—Ä—É–ø–ø–∞ –¥—Ä—É–∑–µ–π',
                avatar: '–ì',
                members: ['–í—ã', '–î—Ä—É–≥ 1', '–î—Ä—É–≥ 2'],
                online: 3,
                type: 'group'
            });
            
            // –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            messages['TEST-CONTACT'] = [
                { sender: '–î—Ä—É–≥ 1', text: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?', time: '10:30', isMe: false },
                { sender: '–í—ã', text: '–ü—Ä–∏–≤–µ—Ç! –í—Å—ë –æ—Ç–ª–∏—á–Ω–æ!', time: '10:31', isMe: true },
                { sender: '–î—Ä—É–≥ 1', text: '–•–æ—á–µ—à—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç?', time: '10:32', isMe: false }
            ];
            
            messages['TEST-GROUP'] = [
                { sender: '–î—Ä—É–≥ 1', text: '–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!', time: '10:00', isMe: false },
                { sender: '–î—Ä—É–≥ 2', text: '–ü—Ä–∏–≤–µ—Ç!', time: '10:01', isMe: false },
                { sender: '–í—ã', text: '–í—Å–µ–º –∑–¥–æ—Ä–æ–≤–∞!', time: '10:02', isMe: true }
            ];
            
            renderContacts();
            renderGroups();
        }
        
        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–ô ==========
        function handleIncomingConnection(conn) {
            const contactId = conn.peer;
            
            conn.on('open', () => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                connections[contactId] = conn;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    contact.online = true;
                    renderContacts();
                    showNotification(`‚úÖ ${contact.name} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);
                } else {
                    // –ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
                    const newContact = {
                        id: contactId,
                        name: `–î—Ä—É–≥ (${contactId.substring(0, 6)})`,
                        avatar: contactId.charAt(0),
                        online: true,
                        type: 'contact'
                    };
                    contacts.push(newContact);
                    renderContacts();
                    showNotification(`üë§ –ù–æ–≤—ã–π –¥—Ä—É–≥ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è: ${newContact.name}`);
                }
            });
            
            conn.on('data', (data) => {
                try {
                    const message = JSON.parse(data);
                    handleIncomingMessage(contactId, message);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                }
            });
            
            conn.on('close', () => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    contact.online = false;
                    renderContacts();
                }
                delete connections[contactId];
            });
        }
        
        function connectToContact(contactId) {
            if (connections[contactId]) {
                showNotification('‚úÖ –£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
                return;
            }
            
            const conn = peer.connect(contactId);
            connections[contactId] = conn;
            
            conn.on('open', () => {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    contact.online = true;
                } else {
                    contacts.push({
                        id: contactId,
                        name: `–î—Ä—É–≥ (${contactId.substring(0, 6)})`,
                        avatar: contactId.charAt(0),
                        online: true,
                        type: 'contact'
                    });
                }
                renderContacts();
                showNotification('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!');
            });
            
            conn.on('data', (data) => {
                try {
                    const message = JSON.parse(data);
                    handleIncomingMessage(contactId, message);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                }
            });
            
            conn.on('close', () => {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    contact.online = false;
                    renderContacts();
                }
                delete connections[contactId];
            });
        }
        
        // ========== –°–û–û–ë–©–ï–ù–ò–Ø ==========
        function handleIncomingMessage(fromId, message) {
            if (!messages[fromId]) {
                messages[fromId] = [];
            }
            
            messages[fromId].push({
                sender: message.sender || '–î—Ä—É–≥',
                text: message.text,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                isMe: false
            });
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º
            if (currentChat && currentChat.id === fromId) {
                renderMessages();
            }
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const contact = contacts.find(c => c.id === fromId);
            if (contact) {
                showNotification(`${contact.name}: ${message.text.substring(0, 30)}...`);
            }
        }
        
        function sendMessage() {
            if (!currentChat) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É —Å–µ–±—è
            if (!messages[currentChat.id]) {
                messages[currentChat.id] = [];
            }
            
            messages[currentChat.id].push({
                sender: myName,
                text: text,
                time: time,
                isMe: true
            });
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
            if (currentChat.type === 'contact') {
                // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const conn = connections[currentChat.id];
                if (conn && conn.open) {
                    conn.send(JSON.stringify({
                        sender: myName,
                        text: text,
                        time: time
                    }));
                }
            } else if (currentChat.type === 'group') {
                // –ì—Ä—É–ø–ø–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º)
                const group = groups.find(g => g.id === currentChat.id);
                if (group) {
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
                    showNotification('üì¢ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø–ø—É');
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            input.value = '';
            renderMessages();
            renderContacts();
            renderGroups();
        }
        
        // ========== UI –§–£–ù–ö–¶–ò–ò ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'contacts') {
                document.getElementById('contactsList').style.display = 'block';
                document.getElementById('groupsList').style.display = 'none';
            } else {
                document.getElementById('contactsList').style.display = 'none';
                document.getElementById('groupsList').style.display = 'block';
            }
        }
        
        function renderContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = '';
            
            contacts.forEach(contact => {
                const lastMessage = messages[contact.id] ? 
                    messages[contact.id][messages[contact.id].length - 1] : null;
                
                const div = document.createElement('div');
                div.className = `contact-item ${currentChat && currentChat.id === contact.id ? 'active' : ''}`;
                div.onclick = () => selectChat(contact);
                div.innerHTML = `
                    <div class="contact-avatar">${contact.avatar}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status ${contact.online ? 'online' : ''}">
                            ${contact.online ? '‚óè –í —Å–µ—Ç–∏' : '‚óè –ù–µ –≤ —Å–µ—Ç–∏'}
                            ${lastMessage ? ` ¬∑ ${lastMessage.text.substring(0, 20)}...` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function renderGroups() {
            const container = document.getElementById('groupsList');
            container.innerHTML = '';
            
            groups.forEach(group => {
                const lastMessage = messages[group.id] ? 
                    messages[group.id][messages[group.id].length - 1] : null;
                
                const div = document.createElement('div');
                div.className = `group-item ${currentChat && currentChat.id === group.id ? 'active' : ''}`;
                div.onclick = () => selectChat(group);
                div.innerHTML = `
                    <div class="group-avatar">${group.avatar}</div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-members">
                            üë• ${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                            ${lastMessage ? ` ¬∑ ${lastMessage.sender}: ${lastMessage.text.substring(0, 20)}...` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function selectChat(chat) {
            currentChat = chat;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('chatTitle').textContent = chat.name;
            document.getElementById('chatAvatar').textContent = chat.avatar;
            document.getElementById('chatStatus').textContent = 
                chat.type === 'contact' ? 
                (chat.online ? '‚óè –í —Å–µ—Ç–∏' : '‚óè –ù–µ –≤ —Å–µ—Ç–∏') :
                `üë• ${chat.members ? chat.members.length : 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            renderContacts();
            renderGroups();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            renderMessages();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç
            if (chat.type === 'contact' && !chat.online) {
                connectToContact(chat.id);
            }
        }
        
        function renderMessages() {
            if (!currentChat) return;
            
            const container = document.getElementById('messagesContainer');
            const chatMessages = messages[currentChat.id] || [];
            
            container.innerHTML = '';
            
            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 40px;">
                        <h3>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</h3>
                        <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                `;
                return;
            }
            
            chatMessages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.isMe ? 'sent' : 'received'}`;
                div.innerHTML = `
                    <div class="message-sender">${msg.sender}</div>
                    <div>${msg.text}</div>
                    <div class="message-time">${msg.time}</div>
                `;
                container.appendChild(div);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function toggleSidePanel(type) {
            const panel = document.getElementById('sidePanel');
            const content = document.getElementById('sidePanelContent');
            
            if (panel.classList.contains('active') && !type) {
                panel.classList.remove('active');
                return;
            }
            
            panel.classList.add('active');
            
            if (type === 'settings') {
                document.getElementById('sidePanelTitle').textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞';
                content.innerHTML = `
                    <div class="settings-section">
                        <h4>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
                        <div class="setting-item">
                            <span>–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <span>–í–∏–±—Ä–æ—Å–∏–≥–Ω–∞–ª</span>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h4>
                        <div class="setting-item">
                            <span>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <span>–ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç</span>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="modal-btn primary" onclick="clearChatHistory()" style="width: 100%; margin-top: 20px;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                `;
            } else if (type === 'members') {
                if (!currentChat || currentChat.type !== 'group') {
                    content.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</p>';
                    return;
                }
                
                document.getElementById('sidePanelTitle').textContent = `–£—á–∞—Å—Ç–Ω–∏–∫–∏ (${currentChat.members.length})`;
                content.innerHTML = `
                    <div class="members-list">
                        ${currentChat.members.map(member => `
                            <div class="member-item">
                                <div class="member-avatar">${member.charAt(0)}</div>
                                <div>
                                    <div style="font-weight: 600;">${member}</div>
                                    <div style="font-size: 12px; color: #94a3b8;">${member === myName ? '–í—ã' : '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="modal-btn primary" onclick="addMemberToGroup()" style="width: 100%; margin-top: 20px;">
                        üë§ –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    </button>
                `;
            }
        }
        
        // ========== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ==========
        function showAddModal() {
            document.getElementById('addModal').classList.add('active');
        }
        
        function showAddContactModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('addContactModal').classList.add('active');
        }
        
        function showCreateGroupModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('createGroupModal').classList.add('active');
        }
        
        function showSettings() {
            document.getElementById('settingsUserId').textContent = myId || '–ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('nameInput').value = myName;
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function hideModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        function addContact() {
            const id = document.getElementById('contactIdInput').value.trim();
            const name = document.getElementById('contactNameInput').value.trim() || `–î—Ä—É–≥ (${id.substring(0, 6)})`;
            
            if (!id) {
                showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞');
                return;
            }
            
            if (id === myId) {
                showNotification('‚ùå –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
                return;
            }
            
            if (contacts.find(c => c.id === id)) {
                showNotification('‚ùå –≠—Ç–æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');
                return;
            }
            
            contacts.push({
                id: id,
                name: name,
                avatar: name.charAt(0),
                online: false,
                type: 'contact'
            });
            
            hideModal();
            renderContacts();
            showNotification(`üë§ –ö–æ–Ω—Ç–∞–∫—Ç "${name}" –¥–æ–±–∞–≤–ª–µ–Ω`);
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            connectToContact(id);
        }
        
        function createGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            const ids = document.getElementById('groupIdsInput').value.trim();
            
            if (!name) {
                showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                return;
            }
            
            const groupId = 'GROUP-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            const members = ['–í—ã'];
            
            if (ids) {
                ids.split(',').forEach(id => {
                    const trimmed = id.trim();
                    if (trimmed && trimmed !== myId) {
                        members.push(`–£—á–∞—Å—Ç–Ω–∏–∫ (${trimmed.substring(0, 6)})`);
                    }
                });
            }
            
            groups.push({
                id: groupId,
                name: name,
                avatar: name.charAt(0),
                members: members,
                online: members.length,
                type: 'group'
            });
            
            hideModal();
            renderGroups();
            showNotification(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ì—Ä—É–ø–ø–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞`);
        }
        
        function saveSettings() {
            const newName = document.getElementById('nameInput').value.trim();
            if (newName && newName.length > 0) {
                myName = newName;
                document.getElementById('userName').textContent = myName;
                showNotification('‚úÖ –ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ');
            }
            hideModal();
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ==========
        function updateUI() {
            if (myId) {
                document.getElementById('userId').textContent = `ID: ${myId}`;
            }
        }
        
        function copyMyId() {
            if (!myId) {
                showNotification('‚ùå ID –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }
            
            navigator.clipboard.writeText(myId)
                .then(() => showNotification('‚úÖ ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É'))
                .catch(() => {
                    const input = document.createElement('input');
                    input.value = myId;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    showNotification('‚úÖ ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
                });
        }
        
        function startCall() {
            if (!currentChat) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞');
                return;
            }
            
            if (currentChat.type === 'group') {
                showNotification('üìû –ù–∞—á–∏–Ω–∞–µ–º –≥—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫...');
            } else {
                showNotification(`üìû –ó–≤–æ–Ω–æ–∫ ${currentChat.name}...`);
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function clearChatHistory() {
            if (!currentChat) return;
            
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
                messages[currentChat.id] = [];
                renderMessages();
                showNotification('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
            }
        }
        
        function addMemberToGroup() {
            const memberId = prompt('–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:');
            if (memberId && currentChat) {
                currentChat.members.push(`–£—á–∞—Å—Ç–Ω–∏–∫ (${memberId.substring(0, 6)})`);
                showNotification('üë§ –£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
                toggleSidePanel('members');
            }
        }
        
        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.querySelector('#notificationText').textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ========== –ó–ê–ü–£–°–ö ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>